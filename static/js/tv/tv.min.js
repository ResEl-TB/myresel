function overflows(e){return e.scrollWidth>e.offsetWidth||parseFloat(window.getComputedStyle(e).width)>parseFloat(window.getComputedStyle(e.parentNode).width)}function formatTime(e,t){var i="";return e<10&&(i+="0"),i+=`${e}:`,t<10&&(i+="0"),i+t}function displayDuration(e,t,i){if(!e||!t)return"Indisponible";var s=Math.floor((t-e)/3600),n=Math.floor((t-e)/60)%60;let a="";return i?formatTime(s,n):(s&&(a+=`${s} h`,n&&(a+=" ")),n&&(a+=`${n} min`),a)}function displayTime(e){var t=new Date(1e3*e);return formatTime(t.getHours(),t.getMinutes())}function displayRange(e,t){return t?`De ${displayTime(e)} à ${displayTime(t)}`:"Durée indéterminée"}function ajaxGet(e,t){var i=new XMLHttpRequest;i.onreadystatechange=()=>{if(4==i.readyState&&200==i.status){let e;try{e=JSON.parse(i.responseText)}catch(e){return void console.log(`${e.message} in ${i.responseText}`)}t(e)}},i.open("GET",e,!0),i.send()}function Program(e,t,i,s,n){this.title=e,this.subtitle=t,this.start=i,this.end=s,this.desc=n}class ResElTV extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"}),t=document.createElement("div");t.id="container",t.innerHTML='<div id="loading"><div id="logo"><svg viewBox="119 91.42 187.17 51" id="resel"><style>.a{fill:#FFF;}</style><polygon points="298 142.42 119 142.42 119 91.42 306.17 91.42 "></polygon><path d="M135.84 121.09L133.16 137h-8.97l6.68-39.99h14.8c3.73 0 6.61 0.41 8.63 1.22 2.02 0.81 3.61 2.2 4.78 4.16 1.16 1.96 1.74 4.03 1.74 6.19 0 2.33-0.7 4.54-2.09 6.65 -1.4 2.11-3.69 3.58-6.9 4.42L156.8 137h-9.34l-4.2-15.91H135.84zM138.52 104.01l-1.71 10.14h5.92c2.29 0 3.97-0.15 5.05-0.45s1.97-0.89 2.67-1.76c0.69-0.87 1.04-1.94 1.04-3.21 0-1.66-0.53-2.86-1.6-3.6 -1.06-0.74-2.84-1.11-5.31-1.11H138.52z" class="a"></path><path d="M198.46 97.01l-1.29 7.59h-18.8l-1.37 8.2h15.72l-1.2 7.24h-15.73l-1.57 9.38h19.14L192.07 137h-28.48l6.68-39.99H198.46z" class="a"></path><path d="M229.66 106.82l-8.2 1.9c-0.94-3.32-3.21-4.98-6.83-4.98 -1.68 0-3.01 0.4-4 1.2 -0.99 0.8-1.48 1.77-1.48 2.9 0 1.13 0.4 1.99 1.2 2.57 0.8 0.59 2.33 1.16 4.6 1.73 3.26 0.82 5.83 1.68 7.71 2.59 1.88 0.91 3.32 2.18 4.32 3.81s1.51 3.62 1.51 5.96c0 3.77-1.39 6.91-4.16 9.44s-6.72 3.79-11.84 3.79c-4.37 0-8.01-1.01-10.91-3.03 -2.9-2.02-4.7-5.06-5.4-9.13l8.56-1.17c0.88 3.97 3.58 5.95 8.12 5.95 2.05 0 3.62-0.44 4.72-1.31 1.09-0.88 1.64-1.99 1.64-3.33 0-1.28-0.42-2.21-1.25-2.79 -0.83-0.57-2.76-1.27-5.79-2.1 -2.75-0.73-4.94-1.53-6.58-2.41 -1.63-0.88-2.93-2.12-3.9-3.73 -0.97-1.61-1.45-3.45-1.45-5.52 0-3.38 1.28-6.35 3.84-8.93s6.08-3.86 10.58-3.86C222.39 96.37 227.39 99.85 229.66 106.82z" class="a"></path><path d="M267.16 97.01l-1.29 7.59h-18.8l-1.37 8.2h15.72l-1.2 7.24h-15.73l-1.57 9.38h19.14L260.77 137h-28.48l6.68-39.99H267.16z" class="a"></path><path d="M282.43 97.01l-5.41 32.4h15.75l-1.26 7.59h-24.93l6.68-39.99H282.43z" class="a"></path></svg><svg viewBox="226.4 157.7 70.5 42.7" id="tv"><path d="M257.7 165.8h-10.7l-5.8 34.6h-9.8l5.8-34.6h-10.7l1.3-8.1h31.3L257.7 165.8z"></path><path d="M296.9 157.7l-19.6 42.7h-10.3l-6.3-42.7h9.8l4.1 31.9 13.8-31.9H296.9z"></path></svg><div id="loader-container"><div id="loader"></div></div></div></div><div id="epg-switch"></div><div id="guide"><div id="date"></div><div id="hours-tracker"></div><div id="guide-channels"><div id="channel-names"></div><div id="channels-guide"></div><div id="time-tracker"></div></div><div id="guide-popup"><div id="popup-close"></div><div id="popup-image"></div><div id="popup-duration"></div><img id="popup-rating"><div id="popup-title"></div><span id="popup-num" class="num"></span><div id="popup-subtitle"></div><div id="popup-description"></div></div></div><div id="video"><div id="overlay"><div id="overlay-title">Bienvenue sur ResEl TV</div><div id="separator"></div><div id="overlay-page" class="container-y" scrollable-y><div class="wrapper-sb"><div class="content-y"><div id="overlay-rating"></div><div id="overlay-subtitle">Veuillez sélectionner une chaîne ci-dessous pour commencer.</div><span id="overlay-num" class="num"></span><div id="overlay-description"></div><div id="overlay-time"></div></div></div><div class="scrollbar-y hidden-sb"><div class="scroll-y"></div></div></div><div id="videobar"><div class="progressbar"><div id="overlay-progress" class="progress"></div></div><div class="playpause-container"><div id="play-pause" class="overlay-button"></div></div><div id="sound-container"><svg id="sound" viewBox="0 0 297.6 290"><polygon points="0 95.4 0 194.6 66.1 194.6 148.8 277.3 148.8 12.7 66.1 95.4"></polygon><path d="M223.2 145c0-28.8-16.9-53.9-41.3-66.1v132.3C206.4 199.9 223.2 174.3 223.2 145z" id="volume1"></path><path d="M181.9 0v34.1c47.8 14.2 82.7 58.5 82.7 111S229.7 241.8 181.9 256v34.1c66.3-15 115.8-74.2 115.8-145S248.2 15 181.9 0z" id="volume2"></path></svg><input id="volume" value="100" type="range"></div><div id="duration-indicator"></div><svg id="fullscreen" class="overlay-button" viewBox="10 10 16 16"><path d="m10 16 2 0 0-4 4 0 0-2L10 10l0 6 0 0z"></path><path d="m20 10 0 2 4 0 0 4 2 0L26 10l-6 0 0 0z"></path><path d="m24 24-4 0 0 2L26 26l0-6-2 0 0 4 0 0z"></path><path d="M12 20 10 20 10 26l6 0 0-2-4 0 0-4 0 0z"></path></svg></div></div><video preload="auto"></video></div><div id="channels"></div>';const i=document.createElement("link");i.rel="stylesheet",i.href="/static/css/tv/style.css";const s=document.createElement("link");s.rel="stylesheet",s.href="/static/css/tv/scrollbar.css",e.appendChild(i),e.appendChild(s),e.appendChild(t),this.container=t,this.shadow=e,this.loadingDiv=e.getElementById("loading"),this.videoDiv=e.getElementById("video"),this.channelsDiv=e.getElementById("channels"),this.interacting=0,this.state=0,this.mouseTimer=null,this.cursorVisible=!0,this.channels=[],this.volume=100,this.previousVolume=100,this.playing=!0,this.init=!1,this.player=dashjs.MediaPlayer().create(),this.player.initialize(this.videoDiv.querySelector("video")),ScrollBarX.initEl(this.channelsDiv),this.channelsDiv=this.channelsDiv.firstChild.firstChild,this.channelsDiv.onmouseover=()=>{this.interacting++},this.channelsDiv.onmouseout=()=>{this.interacting--},this.videobar=e.getElementById("videobar"),this.videobar.onmouseover=()=>{this.interacting++},this.videobar.onmouseout=()=>{this.interacting--};var n=(()=>{this.mouseTimer&&window.clearTimeout(this.mouseTimer),2==this.state&&(this.container.classList.remove("expanded"),this.state=0),this.state+this.interacting==0&&(this.mouseTimer=window.setTimeout(this.expand.bind(this),1e3))}).bind(this);this.container.onmousemove=n,this.container.onmouseup=n,this.container.onmousedown=n,this.playPauseButton=e.getElementById("play-pause"),this.playPauseButton.onclick=(()=>{this.playPause(this.playPauseButton)}).bind(this);var a=e.getElementById("volume");a.oninput=this.updateVolume(a),a.onchange=this.updateVolume(a),a.onmousedown=()=>{a.value>0&&(this.previousVolume=a.value)},e.getElementById("sound").onclick=()=>{this.switchVolume()},e.getElementById("fullscreen").onclick=()=>{this.fullScreen()},this.guideDiv=e.getElementById("guide"),this.dateDiv=e.getElementById("date"),this.trackerDiv=e.getElementById("hours-tracker"),this.channelNamesDiv=e.getElementById("channel-names"),this.channelsGuideDiv=e.getElementById("channels-guide"),this.numDiv=e.getElementById("popup-num"),e.getElementById("popup-close").onclick=()=>{this.hidePopup()},this.channelsGuideDiv.onscroll=(()=>{const e=this.dateDiv.getBoundingClientRect(),t=e.x+e.width,i=this.shadow.querySelectorAll(".last-of-day");let s;for(s=0;s<i.length;s++){const e=i[s].getBoundingClientRect();if(e.x+e.width>t)break}this.dateDiv.firstChild.style.marginLeft=`-${100*s}%`,this.shadow.getElementById("channel-names").scrollTop=this.channelsGuideDiv.scrollTop,this.shadow.getElementById("hours-tracker").scrollLeft=this.channelsGuideDiv.scrollLeft}).bind(this),this.epg=!1,e.getElementById("epg-switch").onclick=()=>{this.switchEpg()},ajaxGet("https://tvapi.resel.fr/v0/channels",(e=>{for(var t of e)this.channelsDiv.insertAdjacentHTML("beforeend",`<div tabindex="0" class="channel" data-lcn="${t.lcn}"><div class="flip"><div class="card"><div class="channel-logo" style="background-image: url('/static/images/tv/channels/${t.sid}.png');"></div><div class="channel-more"><div class="more-button"></div></div></div></div><div class="program"><div class="program-title"></div><div class="progressbar"><div class="progress"></div></div><div class="duration"></div></div><div class="middle"><div class="details"><span class="num"></span><div class="subtitle"></div><div class="rating"></div></div><div class="time"></div></div><div class="right"><div class="description"><p></p></div></div></div>`),t.channelDiv=this.channelsDiv.lastChild,t.channelDiv.onclick=this.switchChannel(t),t.channelDiv.querySelector(".description").onclick=e=>{e.stopPropagation()},t.channelDiv.querySelector(".channel-more").onclick=this.switchView(t),ScrollBarY.initEl(t.channelDiv.querySelector(".description")),this.channels.push(t);this.update(),this.loadingDiv.classList.add("done"),setTimeout((()=>{this.container.removeChild(this.loadingDiv)}).bind(this),1e3),setInterval(this.update.bind(this),2e4),setInterval(this.softUpdate.bind(this),2e3)}).bind(this))}fullScreen(){var e=this.container||document.documentElement;document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),this.container.classList.remove("fullscreen")):(e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),this.container.classList.add("fullscreen"))}switchEpg(){if(this.epg){for(this.epg=!1,this.container.classList.remove("guide"),this.guideDiv.classList.remove("popup");this.dateDiv.firstChild;)this.dateDiv.removeChild(this.dateDiv.lastChild);for(;this.trackerDiv.firstChild;)this.trackerDiv.removeChild(this.trackerDiv.lastChild);for(;this.channelNamesDiv.firstChild;)this.channelNamesDiv.removeChild(this.channelNamesDiv.lastChild);for(;this.channelsGuideDiv.firstChild;)this.channelsGuideDiv.removeChild(this.channelsGuideDiv.lastChild)}else{this.epg=!0,this.container.classList.add("guide"),this.container.classList.add("loading");let e=new Date,t=new Date(e);t.setHours(0,0,0,0),t.setDate(t.getDate()-1);let i=new Date(t);i.setDate(t.getDate()+4);let s=new Date(t),n=t.getDay();ajaxGet(`https://tvapi.resel.fr/v0/epg?start=${t.getTime()/1e3}&end=${i.getTime()/1e3}`,a=>{for(let e=0;e<4;e++){const e=document.createElement("span"),t=Intl.DateTimeFormat(void 0,{weekday:"long",month:"numeric",day:"numeric"}).format(s);e.innerHTML=t.charAt(0).toUpperCase()+t.slice(1),this.dateDiv.appendChild(e),s.setDate(s.getDate()+1)}for(s.setDate(s.getDate()-4);s.getTime()<i.getTime();){const e=document.createElement("div");e.classList.add("time-indicator"),s.getDay()!=n&&(this.trackerDiv.lastChild.classList.add("last-of-day"),n=s.getDay()),e.innerHTML=`${displayTime(s.getTime()/1e3)}`,this.trackerDiv.appendChild(e),s.setTime(s.getTime()+36e5)}this.markerDiv=document.createElement("div"),this.markerDiv.id="time-marker",this.trackerDiv.appendChild(this.markerDiv);for(let e of this.channels){const i=document.createElement("div");i.className="channel-name",i.innerHTML=e.name,this.channelNamesDiv.appendChild(i);const s=document.createElement("div");if(s.className="channel-guide",a[e.sid])for(let i of a[e.sid]){const e=document.createElement("div");e.classList.add("channel-program");const n=i.end-i.start;n<300?e.classList.add("tiny"):n<=600?e.classList.add("small"):n>=1500&&i.icon&&e.classList.add("big"),e.style.left=`${(i.start-t.getTime()/1e3)/60}vh`,e.style.width=`${(i.end-i.start)/60}vh`,e.innerHTML=`<div class="image" style="background-image: url(https://tvapi.resel.fr/images/${i.icon})"></div><div class="duration">${displayRange(i.start,i.end)}</div><div class="title">${i.title}</div>`,e.onclick=()=>{this.showPopup(i)},s.appendChild(e)}this.channelsGuideDiv.appendChild(s)}this.container.classList.remove("loading"),this.channelsGuideDiv.scrollLeft=window.innerHeight*(e.getTime()-t.getTime())/6e6-this.channelsGuideDiv.offsetWidth/2,this.markerDiv.style.left=`${(e.getTime()-t.getTime())/6e4}vh`,this.channelsGuideDiv.dispatchEvent(new CustomEvent("scroll"))})}}showPopup(e){this.guideDiv.classList.add("popup"),this.shadow.getElementById("popup-image").style.backgroundImage=`url(https://tvapi.resel.fr/images/${e.icon})`,this.shadow.getElementById("popup-duration").innerHTML=displayRange(e.start,this.currentTime);let t=e.rating;if(t&&t.value&&(this.shadow.getElementById("popup-rating").alt=t.value,this.shadow.getElementById("popup-rating").src=`/static/images/tv/ratings/${t.system}/${t.value}.svg`),e.num){this.numDiv.style.display="inline";for(let t of["season","episode","part"])if(e.num[t]){const i=document.createElement("span");i.classList.add(t),i.innerHTML=e.num[t],this.numDiv.appendChild(i)}}else this.numDiv.style.display="none";this.shadow.getElementById("popup-title").innerHTML=e.title,this.shadow.getElementById("popup-subtitle").innerHTML=e.subtitle||"",this.shadow.getElementById("popup-description").innerHTML=e.description||"Description indisponible"}hidePopup(){for(this.guideDiv.classList.remove("popup");this.numDiv.firstChild;)this.numDiv.removeChild(this.numDiv.lastChild)}updateOverlay(e){var t=this.shadow.getElementById("overlay-title");t.innerHTML=e.channelDiv.querySelector(".program-title").innerHTML;let i=e.channelDiv.querySelector(".subtitle").innerHTML,s=this.shadow.getElementById("overlay-subtitle");s.innerHTML=i,s.style.display=i?"block":"none";let n=this.shadow.getElementById("overlay-num");for(;n.firstChild;)n.removeChild(n.lastChild);e.currentProgram.num?(n.style.display="inline-block",n.innerHTML=e.channelDiv.querySelector(".num").innerHTML):n.style.display="none",this.shadow.getElementById("overlay-rating").innerHTML=e.channelDiv.querySelector(".rating").innerHTML,this.shadow.getElementById("overlay-description").innerHTML=e.channelDiv.querySelector(".description p").innerHTML,this.shadow.getElementById("overlay-time").innerHTML=e.channelDiv.querySelector(".time").innerHTML,this.shadow.getElementById("overlay-progress").style.width=e.channelDiv.querySelector(".progress").style.width,this.shadow.getElementById("duration-indicator").innerHTML=`${displayDuration(e.currentProgram.start,this.currentTime,!0)} / ${displayDuration(e.currentProgram.start,e.currentProgram.end,!0)}`,overflows(t)?t.classList.add("overflow"):t.classList.remove("overflow")}finishInitialization(){this.init=!0,this.videobar.style.display="block"}switchChannel(e){return(()=>{if(window.clearTimeout(this.audioInitTimeout),this.container.classList.remove("detailed"),this.init?this.currentChannel.channelDiv.classList.remove("active"):this.finishInitialization(),e.channelDiv.classList.remove("selected"),e.channelDiv.classList.add("active"),this.currentChannel=e,this.state){var t=e.channelDiv.getBoundingClientRect();this.channelsDiv.scrollLeft=t.x+(t.width-this.channelsDiv.clientWidth)*this.scrollRatio-parseFloat(window.getComputedStyle(e.channelDiv).marginRight)}this.state=0,this.player.attachSource(`https://tnt.resel.fr/play/dash/${e.sid}/index.mpd`),this.init&&this.updateOverlay(e),this.playing=!0,this.playPauseButton.classList.remove("paused");const i=(()=>{const e=this.player.getTracksFor("audio")[0];e?this.player.setCurrentTrack(e):this.audioInitTimeout=setTimeout(i,500)}).bind(this);i(),window.dispatchEvent(new Event("update"))}).bind(this)}switchView(e){return(t=>{if(t.stopPropagation(),this.state){this.container.classList.remove("detailed"),e.channelDiv.querySelector(".channel-more").style.visibility="hidden",setTimeout((()=>{e.channelDiv.querySelector(".channel-more").style.visibility=""}).bind(this),200),e.channelDiv.classList.remove("selected"),this.state=0;var i=this.channelsDiv.children;for(let e=0;e<i.length;e++){overflows(i[e].querySelector(".program-title"))?i[e].classList.add("overflow"):i[e].classList.remove("overflow")}let t=e.channelDiv.getBoundingClientRect();this.channelsDiv.scrollLeft=t.x+(t.width-this.channelsDiv.clientWidth)*this.scrollRatio-parseFloat(window.getComputedStyle(e.channelDiv).marginRight)}else{let t=e.channelDiv.getBoundingClientRect();this.scrollRatio=t.x/(this.channelsDiv.clientWidth-t.width+2*parseFloat(window.getComputedStyle(e.channelDiv).marginRight)),this.container.classList.add("detailed"),e.channelDiv.classList.add("selected"),overflows(e.channelDiv.querySelector(".program-title"))?e.channelDiv.classList.add("expoverflow"):e.channelDiv.classList.remove("expoverflow"),this.state=1,e.channelDiv.querySelector(".content-y").scrollTop=0}window.dispatchEvent(new Event("update"))}).bind(this)}expand(){this.init&&this.playing&&(this.mouseTimer=null,this.container.classList.add("expanded"),this.state=2)}updateVolume(e){return(()=>{this.volume=e.value,this.shadow.querySelector("video").volume=e.value/100,this.shadow.getElementById("volume1").classList.add("hidden"),this.shadow.getElementById("volume2").classList.add("hidden"),e.value>0&&(this.shadow.getElementById("volume1").classList.remove("hidden"),e.value>=50&&this.shadow.getElementById("volume2").classList.remove("hidden"))}).bind(this)}switchVolume(){var e=this.shadow.getElementById("volume");this.volume>0?(this.previousVolume=this.volume,e.value=0):(this.volume=this.previousVolume,e.value=this.volume),this.updateVolume(e)()}playPause(e){this.playing?(this.player.pause(),this.playing=!1,e.classList.add("paused")):(this.player.play(),this.playing=!0,e.classList.remove("paused"))}softUpdate(){const e=new Date;this.currentTime=Math.round(e.getTime()/1e3);var t=this.channels.length;for(let e=0;e<t;e++){const t=this.channels[e];t.currentProgram&&(t.channelDiv.querySelector(".progress").style.width=`${t.currentProgram.start?Math.min(100*(this.currentTime-t.currentProgram.start)/(t.currentProgram.end-t.currentProgram.start),100):0}%`)}if(this.init&&this.updateOverlay(this.currentChannel),this.markerDiv){let t=new Date(e);t.setHours(0,0,0,0),t.setDate(t.getDate()-1),this.markerDiv.style.left=`${(this.currentTime-t.getTime()/1e3)/60}vh`}}update(){this.currentTime=Math.round((new Date).getTime()/1e3),ajaxGet(`https://tvapi.resel.fr/v0/programs?timestamp=${this.currentTime}`,e=>{for(let s=0;s<this.channels.length;s++){var t=this.channels[s];t.currentProgram=e[t.sid]||new Program;var i=t.channelDiv.querySelector(".program-title");i.innerHTML=t.currentProgram.title||"Indisponible",t.channelDiv.querySelector(".duration").innerHTML=displayDuration(t.currentProgram.start,t.currentProgram.end);let n=t.channelDiv.querySelector(".num");for(;n.firstChild;)n.removeChild(n.lastChild);if(t.currentProgram.num){n.style.display="inline";for(let e of["season","episode","part"])if(t.currentProgram.num[e]){const i=document.createElement("span");i.classList.add(e),i.innerHTML=t.currentProgram.num[e],n.appendChild(i)}}else n.style.display="none";t.channelDiv.querySelector(".subtitle").innerHTML=t.currentProgram.subtitle||"";let a=t.currentProgram.rating,l=t.channelDiv.querySelector(".rating");if(a&&a.value)l.innerHTML=`<img alt="${a.value}" src="/static/images/tv/ratings/${a.system}/${a.value}.svg">`;else for(;l.firstChild;)l.removeChild(l.lastChild);t.channelDiv.querySelector(".time").innerHTML=displayRange(t.currentProgram.start,t.currentProgram.end),t.channelDiv.querySelector(".description p").innerHTML=t.currentProgram.description||"Description indisponible",t.channelDiv.onclick=this.switchChannel(t),overflows(i)?t.channelDiv.classList.add("overflow"):t.channelDiv.classList.remove("overflow"),t.channelDiv.querySelector(".progress").style.width=`${t.currentProgram.start?Math.min(100*(this.currentTime-t.currentProgram.start)/(t.currentProgram.end-t.currentProgram.start),100):0}%`,this.init&&this.updateOverlay(this.currentChannel),window.dispatchEvent(new Event("update"))}})}}customElements.define("resel-tv",ResElTV);
