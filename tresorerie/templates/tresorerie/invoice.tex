%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Copyright Association ResEl - LICENSE MIT
%
% This document is a latex template of invoice, generated by the association
% ResEl, for its members.
%
% This template use an improved version of invoice latex template
% of Trey Hunner (https://github.com/treyhunner/invoices)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%
% TO EDIT THE TEMPLATE, GO TO LINE ~142
% Variables :
% - confLang : 'en' or 'fr'
% - user : object that contains
%   - uid
%   - first_name
%   - last_name
%   - address_first
%   - address_second
% - transaction :object that contains
%   - uuid
%   - date : generation date, should be `today`
%   - date_paiement : payement date (if payed)
%   - categories : list composed of object :
%     - name : the name of the categories
%     - products : a list composed of object :
%        - quantity : the quantity buyed
%        - name : the designation of the product
%        - price : the unit price of the product
%%%%%

%---------------------------------------------------------------------- Header
{# Manually set language #}
{% load i18n %}
{% language confLang %}

%--------------------------------------------------- Package includes & config
\documentclass[12pt]{article}
\usepackage[utf8]{inputenc}

\usepackage[T1]{fontenc}
\usepackage[francais]{babel}
\usepackage{lmodern}
\usepackage{eurosym}

\usepackage[letterpaper,hmargin=0.79in,vmargin=0.79in]{geometry}
\usepackage[parfill]{parskip} % Do not indent paragraphs
\usepackage{fp} % Fixed-point arithmetic
\usepackage{calc} % Counters for totaling hours and cost
\usepackage{longtable}
\usepackage{ifthen}

\pagestyle{empty} % No page numbers
\linespread{1.5}

\setlength{\doublerulesep}{\arrayrulewidth} % Double rules look like one thick one

\def\confLang{% templatetag openbrace %}{{ confLang }}{% templatetag closebrace %}

%--------------------------------------------------- Invoice command & env definitions
% Command for setting a default hourly rate
\newcommand{\hourlyrate}[1]{\def \@hourlyrate {#1}}
\hourlyrate{1}
\newcommand{\feetype}[1]{
    \textbf{#1}
    \\
}

% Counters for totaling up hours and dollars
\newcounter{hours} \newcounter{subhours} \newcounter{cost} \newcounter{subcost}
\setcounter{hours}{0} \setcounter{subhours}{0} \setcounter{cost}{0} \setcounter{subcost}{0}

% Formats inputed number with 2 digits after the decimal place
\newcommand*{\formatNumber}[1]{\FPround{\cost}{#1}{2}\cost} %

% Returns the total of counter
\newcommand*{\total}[1]{\FPdiv{\t}{\arabic{#1}}{1000}\formatNumber{\t}}

% Create an invoice table
\newenvironment{invoiceTable}{
    % Create a new row : title, unit quantity, unit rate, and unit name
    \newcommand*{\unitrow}[4]{%
         \addtocounter{cost}{1000 * \real{##2} * \real{##3}}%
         \addtocounter{subcost}{1000 * \real{##2} * \real{##3}}%
         ##1 & ##2 ##4 & \formatNumber{##3}\euro & \FPmul{\cost}{##2}{##3}\formatNumber{\cost}\euro%
         \\
    }
    % Create a new row from title and expense amount
    \newcommand*{\feerow}[2]{%
         \addtocounter{cost}{1000 * \real{##2}}%
         \addtocounter{subcost}{1000 * \real{##2}}%
         ##1 & & \formatNumber{##2}\euro & \FPmul{\cost}{##2}{1}\formatNumber{\cost}\euro%
         \\
    }

    \newcommand{\subtotalNoStar}{
        {\bf Subtotal} & {\bf \total{subhours} hours} &  & {\bf \$\total{subcost}}
        \setcounter{subcost}{0}
        \setcounter{subhours}{0}
        \\*[1.5ex]
    }
    \newcommand{\subtotalStar}{
        {\bf Subtotal} & & & {\bf \total{subcost}\euro}
        \setcounter{subcost}{0}
        \\*[1.5ex]
    }
    \newcommand{\subtotal}{
         \hline
         \@ifstar
         \subtotalStar%
         \subtotalNoStar%
    }


    % Create a new row from date and hours worked (use stored fee type and hourly rate)
    \newcommand*{\hourrow}[2]{%
        \addtocounter{hours}{1000 * \real{##2}}%
        \addtocounter{subhours}{1000 * \real{##2}}%
        \unitrow{##1}{##2}{\@hourlyrate}{hours}%
    }
    \renewcommand{\tabcolsep}{0.8ex}
    \setlength\LTleft{0pt}
    \setlength\LTright{0pt}
    \begin{longtable}{@{\extracolsep{\fill}\hspace{\tabcolsep}} l r r r }
    \hline
    {\bf {% trans "Désignation" %}} & \multicolumn{1}{c}{\bf {% trans "Quantité" %}} & \multicolumn{1}{c}{\bf {% trans "Prix unitaire" %}} & \multicolumn{1}{c}{\bf {% trans "Montant" %}} \\*
    \hline\hline
    \endhead
}{
    \hline\hline\hline
    {\bf {% trans "Montant à payer" %}} & & & {\bf \total{cost}\euro} \\
    \end{longtable}
}
\def \tab {\hspace*{3ex}}

\begin{document}

%--------------------------------------------------- Beginning of template

{\Huge\bf ResEl}\hfil{\Huge\bf {% trans "Facture" %}}
\bigskip\break
\hrule

Association ResEl - Télécom Bretagne \hfill (33) 2 29 00 15 76 \\
655, avenue du Technopôle \hfill tresorier@resel.fr \\
29280 Plouzané
France
\\ \\
{\bf {% trans "Délivrée à" %} :} {{user.first_name}} {{user.last_name}}\\
{% for addr in user.address_formated %}\tab {{ addr }} \\{% endfor %}

{\bf {% trans "Date" :}  {{ transaction.date_creation }}

{\bf {% trans "Identifiant de facture" %} :} {{ transaction.uuid}}

{\bf {% trans "Identifiant client" %} :} {{ user.uid }}

%----------------------------------------------------------------------------------------

\begin{invoiceTable}

{% for category in transaction.categories %}
\feetype{ {{category.name|safe}} }
    {% for product in category.products %}
    \unitrow{% templatetag openbrace %}{{ product.nom|safe }}{% templatetag closebrace %}{% templatetag openbrace %}1{% templatetag closebrace %}{% templatetag openbrace %}{{ product.display_price|stringformat:"f" }}{% templatetag closebrace %}{}
    {% endfor %}
{% endfor %}
    
%------------------------------------------------

\end{invoiceTable}

{% trans "(TVA non applicable, art. 293 B du Code Général des Impôts)" %}

%----------------------------------------------------------------------------------------

{% if transaction.statut == "P" %}
{\bf {% trans "Facture acquitée" %}:}  \\
\tab {{ transaction.date_paiement }}  \\
\tab {{ transaction.moyen }}  \\
{% else %}
{\bf {% trans "Paiement" %}:}  \\
\tab {% trans "Paiement avant le" %} : \today \\% {{ transaction.date_paiement }}  \\
\tab {% trans "Moyen de paiement possible" %} : {% trans "Carte banquaire, Chèque, liquide" %}  \\
{% endif %}
\end{document}

{% endlanguage %}
