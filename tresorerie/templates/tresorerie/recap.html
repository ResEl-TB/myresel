{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}

{% block titre %}{% trans "Paiement" %}{% endblock %}

{% block css %}<link rel="stylesheet" type="text/css" href="{% static 'css/tresorerie/choose_product.css' %}"/>{% endblock %}

{% block content %}
    <div class="container">
        <h1 class="page-header">{% trans "Récapitulatif de la commande" %}</h1>
        <div class="row">
            <div class="col-md-7 col-md-offset-1">
                <div class="panel panel-primary">
                    <div class="panel-heading">{{ main_product.nom }}</div>
                    <table class="table table-hover">
                        <tr class="info"><th>{% trans "Généralités" %}</th><th></th></tr>
                        <tr><td>{% trans "Nom" %}</td><td>{{ user.first_name }} {{ user.last_name|upper }}</td></tr>
                        <tr><td>{% trans "E-mail" %}</td><td>{{ user.mail }} </td></tr>
                        <tr><td>{% trans "Identifiant de transaction" %}</td><td>{{ transaction.uuid }}</td></tr>
                        <tr><td>{% trans "Type de paiement" %}</td><td><span class="label label-default">{{ transaction.moyen }}</span></td></tr>
                        <tr class="info"><th >{% trans "Liste des commandes" %}</th><th></th></tr>
                        {% for p in products %}
                            <tr class="active"><td>{% trans "Commande" %}</td><td>{{ p.nom }}</td></tr>
                            <tr><td>{% trans "Durée" %}</td><td>{{ p.duree }} {% trans "mois" %}</td></tr>
                            <tr><td>{% trans "Prix" %}</td><td>{{ p.display_price|floatformat }}€</td></tr>
                        {% endfor %}
                        <tr class="info"><th>{% trans "Total" %}</th><th>{{ transaction.total|floatformat }}€</th></tr>
                    </table>
                </div>
                <form action="" method="post" class="col-lg-6 col-lg-offset-3 text-center form-horizontal">
                    {% csrf_token %}
                    <input type="hidden" name="uuid" value="{{ transaction.uuid }}">
                    <div class="stripe">
                        <button
                                type="submit"
                                class="btn btn-info btn-lg"
                                data-key="pk_test_KE9qQquz3hhdRI54CcfBaukl"
                                data-currency="eur"
                                data-name="Association ResEl"
                                data-description="{{ transaction.full_name }}"
                                data-amount="{{ transaction.total_stripe }}"
                                data-image="{% static 'images/tresorerie/marketplace.png' %}"
                                data-locale="fr"
                                data-email="{{ user.mail }}"
                                data-allow-remember-me="false"
                        ><span class="fa fa-fw fa-credit-card"></span> {% trans 'Payer par carte' %}</button>
                    </div>
                    <br>
                    <input name='price' type='hidden'>
                </form>
            </div>

            <div class="col-md-3 col-md-offset-1">
                <div><a href="{% url 'tresorerie:home' %}"><span class="fa fa-fw fa-long-arrow-left"></span> {% trans "Retour aux offres" %}</a></div>
                <h3>{% trans "Besoin d'aide ?" %}</h3>
                <p>Vous pouvez nous contacter etc...</p>
            </div>
        </div>

    </div>
{% endblock %}

{% block javascript %}
    <script type="text/javascript" src="https://checkout.stripe.com/checkout.js"></script>
    <script>

        $(document).ready(function () {
            $(':submit').on('click', function(event) {
                event.preventDefault();
                var $button = $(this),
                        $form = $button.parents('form');
                var opts = $.extend({}, $button.data(), {
                    token: function(result) {
                        $form.append($('<input>').attr({ type: 'hidden', name: 'stripeToken', value: result.id })).submit();
                    }
                });
                StripeCheckout.open(opts);
            });
        });
    </script>
{% endblock %}